parameters:
  - name: variableName
    type: string
  - name: environment
    type: string
  - name: subscriptionName
    type: string
  - name: outputLocation
    type: string
  - name: resourceGroup
    type: string
    default: ""
  - name: builtFrom
    type: string
    default: ""
  - name: product
    type: string
    default: ""
  - name: libarySecrets
    type: object
    default:
      - secName: "tf_secret_gov-uk-notify-api-testing-key"
        secValue: "$(tf_secret_gov-uk-notify-api-testing-key)"

steps:
  - template: templates\common\get-variable-group.yml@azTemplates
    parameters:
      subscriptionName: ${{ parameters.subscriptionName }}
      variableGroupName: "PIP-APIM-BUILD-${{ parameters.environment }}"
      variableName: "secrets"
      taskName: "group"


  - powershell: |
      $jsonPath="$env:groupJsonPath"

      $variablesJson = Get-Content $jsonPath | Out-String | ConvertFrom-Json

      $names=""
      $variablesJson.variables.PSObject.Properties | ForEach-Object {
        $name=$_.Name
        if ($name -like "tf_secret_*"){
          Write-Host "Found: $name"
          $names+=",$name"
        }
      }
      "##vso[task.setvariable variable=names;isOutput=true]$names"
    displayName: 'get secret names'
    name: "secret"
    env:
      groupJsonPath: $(group.secrets_path)

  - bash: |
      variableName="${{ parameters.variableName }}"
      secureFileJson=$(printenv secure_file_json)
      variableGroupJson=$(printenv variable_group_json)
      variables=""
      variables="-var-file=\"$(System.DefaultWorkingDirectory)/environments/${{ parameters.environment }}.tfvars\""
      variables="${variables} -var-file=\"$(System.DefaultWorkingDirectory)/environments/shared.tfvars\""
      variables="${variables} -out=\"${{ parameters.outputLocation }}\""
      variables="${variables} -var \"builtFrom=${{ parameters.builtFrom }} \""
      variables="${variables} -var \"product=${{ parameters.product }}\""

      variable="$names"
      secretArr=$(for i in ${variable//,/ }
      do
        echo "{\\\"name\\\":\\\"$i\\\",\\\"value\\\":\\\"$($i)\\\"},"
      done)
      secretArr="[${secretArr}]"
      variables="${variables} -var \"secrets_arr=${secretArr}\""

      echo "Variables set as: "
      echo "${variables}"
      echo "##vso[task.setvariable variable=$variableName;isOutput=true]${variables}"
    displayName: 'Set Shared Services TF Variables'
    name: tfVariables
    env:
      names: $(secret.names)
      ${{ each sec in parameters.libarySecrets }}:
        "${{ sec.secName }}" : "${{ sec.secValue }}"